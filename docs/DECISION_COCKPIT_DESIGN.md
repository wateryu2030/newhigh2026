# 决策驾驶舱设计：量化回测可视化 + 交易决策辅助

> 核心目标：用户一眼看到 **什么时候买/卖最好**、理解 **为什么买卖**、看到 **未来可能走势（概率）**。

---

## 一、产品定位：从「工具」到「决策驾驶舱」

### 当前常见问题（本项目的改进方向）

| 问题 | 目标 |
|------|------|
| K 线只是普通图 | K 线 + **买卖区间高亮** + 专业图表交互 |
| 买卖点只是小箭头 | **带评分与标签** 的 BUY/SELL 标记（胜率、盈亏比） |
| 用户不知道策略逻辑 | **信号原因解释面板**（技术原因 + 历史胜率） |
| 看不到最优区间 | **最优买入/卖出区间** 在时间轴上高亮 |
| 未来趋势没有表达 | **概率趋势**（上涨/震荡/下跌概率 + 价格区间带），不做点预测 |

**一句话**：用户不是来看 K 线，是来看 **什么时候赚钱、为什么、有多大概率**。

---

## 二、核心升级 1：买卖最优时间节点

### 2.1 交易区间高亮（必须做）

在 K 线上增加：

- **最优买入区间**：绿色半透明背景
- **最优卖出区间**：红色半透明背景

示意：

```
|----🟢 买入区间 ----|        |----🔴 卖出区间 ----|
     K 线主图
```

**数据接口**（后端回测结果扩展）：

```json
{
  "buyZones": [
    { "start": "2025-01-05", "end": "2025-01-10" }
  ],
  "sellZones": [
    { "start": "2025-02-02", "end": "2025-02-08" }
  ]
}
```

**前端实现**：TradingView Lightweight Charts 的 `markArea` 或 ECharts 的 `markArea` / overlay 层。

### 2.2 最佳买卖点评分（高级感）

在每个信号点显示：

- **买入评分**：如 92（来源：胜率、盈亏比、历史回测表现）
- **卖出评分**：如 87

**数据接口**：

```json
{
  "signals": [
    {
      "date": "2025-01-06",
      "type": "buy",
      "score": 92,
      "winRate": 0.78,
      "avgReturn": 0.068,
      "reasons": ["均线多头排列", "MACD金叉", "成交量放大 132%", "回撤结束"]
    },
    {
      "date": "2025-02-05",
      "type": "sell",
      "score": 87,
      "winRate": 0.74,
      "reasons": ["均线死叉", "MACD顶背离", "跌破支撑"]
    }
  ]
}
```

### 2.3 买卖箭头升级

- 不用普通箭头，改为带标签的 **BUY / SELL** 标记。
- 悬停或点击展示：胜率、平均收益、简要原因。

---

## 三、核心升级 2：信号原因解释面板

**必须**有一个模块：**点击买/卖点 → 展示「为什么」**。

示例内容：

```
买入信号原因：
✔ 均线多头排列
✔ MACD 金叉
✔ 成交量放大 132%
✔ 回撤结束信号

历史胜率：74%
平均收益：6.8%
```

- 数据来源：上文的 `signals[].reasons`、`winRate`、`avgReturn`。
- 没有解释 = 用户不会信；这是**信任来源**。

---

## 四、核心升级 3：未来趋势展示（概率，不预测价格）

**原则**：不做「预测价格」，做 **概率趋势区间**。

### 4.1 概率展示

- 未来 N 日（如 5 日）可能走势：
  - **上涨概率** 62%
  - **震荡概率** 28%
  - **下跌概率** 10%
- 可视化：扇形图或条形图。

### 4.2 价格区间带

- 示例：**预计区间 12.3 — 13.8**
- 在 K 线图右侧用**蓝色虚线预测带**画出区间，而不是单点预测。

**数据接口**：

```json
{
  "futureProbability": {
    "up": 0.62,
    "sideways": 0.28,
    "down": 0.10
  },
  "futurePriceRange": {
    "low": 12.3,
    "high": 13.8,
    "horizonDays": 5
  }
}
```

### 4.3 技术逻辑建议（后端可逐步实现）

- 技术指标方向：MA 斜率、MACD 柱、RSI 位置
- 波动率：ATR 预测区间
- 历史形态：KNN / 形态匹配
- 可选：LSTM / Transformer 等模型

哪怕先用简单规则，也能体现「有逻辑」的专业感。

---

## 五、核心升级 4：策略收益 vs 持有收益

**独立图表**：两条线

- **策略收益曲线**（当前已有 `curve`）
- **持有收益曲线**（买入持有同一标的的净值）

用户一眼看出：**策略是否跑赢持有**。

**数据接口**：在现有 `result.curve` 旁增加 `holdCurve`，格式一致：

```json
{
  "curve": [{"date": "2025-01-01", "value": 1.0}, ...],
  "holdCurve": [{"date": "2025-01-01", "value": 1.0}, ...]
}
```

---

## 六、页面结构（推荐布局）

```
--------------------------------
股票名称 + 当前信号 + 建议操作
--------------------------------

[ K 线主图 + 买卖点 + 买卖区间高亮 ]

--------------------------------
未来趋势预测区
--------------------------------
上涨概率 | 震荡 | 下跌  （+ 价格区间带）

--------------------------------
信号原因解释
--------------------------------
技术指标说明（点击信号时展示）

--------------------------------
回测表现
--------------------------------
收益率、胜率、最大回撤、资金曲线（策略 vs 持有）

--------------------------------
交易记录
--------------------------------
```

---

## 七、技术栈建议

### 图表库

| 推荐 | 说明 |
|------|------|
| **TradingView Lightweight Charts** | 专业 K 线、性能好、开源免费，适合买卖区间与标记 |
| **ECharts** | 国内常用，K 线 + markArea + 概率图、柱状图均可 |

**当前项目**：Flask 后端 + 静态 `static/app.js`（无框架）。可先引入 **TradingView Lightweight Charts** 或 **ECharts** 单文件，不强制上 React/Vue。

### 前端技术选型

- 若保持轻量：**原生 JS + TradingView Lightweight Charts / ECharts**。
- 若后续做多页、状态复杂：再考虑 **Vue 3** 或 **React**。

---

## 八、最关键的两项（优先做）

若资源有限，优先做：

1. **买卖区间高亮 + 概率趋势带**（用户感知价值最高）
2. **策略资金曲线 vs 持有曲线**（信任来源）

---

## 九、数据接口汇总（与现有回测对接）

现有回测结果已包含：`summary`、`curve`。在 **不破坏现有字段** 的前提下扩展为「决策驾驶舱」所需结构：

```json
{
  "summary": { ... },
  "curve": [{"date": "...", "value": 1.0}, ...],
  "holdCurve": [{"date": "...", "value": 1.0}, ...],
  "buyZones": [{"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"}],
  "sellZones": [{"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"}],
  "signals": [
    {
      "date": "YYYY-MM-DD",
      "type": "buy|sell",
      "score": 0-100,
      "winRate": 0.xx,
      "avgReturn": 0.xx,
      "reasons": ["原因1", "原因2"]
    }
  ],
  "futureProbability": { "up": 0.62, "sideways": 0.28, "down": 0.10 },
  "futurePriceRange": { "low": 12.3, "high": 13.8, "horizonDays": 5 },
  "kline": [
    { "date": "YYYY-MM-DD", "open": 10.0, "high": 10.5, "low": 9.8, "close": 10.2, "volume": 1000000 }
  ]
}
```

- `kline`：由后端从数据库/数据源按回测区间生成，供前端画 K 线。
- `buyZones` / `sellZones`：可由回测引擎的成交记录（order/trade）聚合为区间，或由策略在 `handle_bar` 里打标输出。
- `signals`：由策略在产生买卖时写入原因与统计（或由回测层根据历史统计补全）。
- `holdCurve`：回测时用同一标的、同一区间计算「买入持有」净值即可。
- `futureProbability` / `futurePriceRange`：独立模块（技术指标/波动率/形态或模型），可先返回占位或简单规则。

---

## 十、实施路线图（分阶段）

| 阶段 | 内容 | 产出 | 状态 |
|------|------|------|------|
| **Phase 1** | 数据结构与 API：扩展 `last_backtest_result.json`，增加 `buyZones`、`sellZones`、`holdCurve`、`kline`；后端从 DB 输出 K 线、持有曲线，从 trades 推导买卖区间与 signals | 接口稳定、前端可联调 | ✅ 已实现 |
| **Phase 2** | 前端图表：ECharts K 线主图 + 买卖区间高亮（markArea）+ 策略 vs 持有双曲线 | 决策驾驶舱主视觉 | ✅ 已实现 |
| **Phase 3** | 信号与解释：回测输出 `signals`（含 reasons）；前端信号列表 + 点击展示「信号原因」面板 | 用户理解「为什么」 | ✅ 已实现 |
| **Phase 4** | 未来概率：后端 ATR 区间 + 趋势简单概率；前端「未来趋势」区展示概率与预计区间 | 概率趋势，不预测价格 | ✅ 已实现 |
| **Phase 5** | 交互与打磨：窗口 resize 图表自适应、布局与文案 | 产品级体验 | ✅ 已实现 |

---

## 十一、与现有代码的衔接

- **后端**：`web_platform.py` 的 `/api/run_backtest` 已返回 `result`（来自 `output/last_backtest_result.json`）。扩展 `run_backtest_db.py`（或统一写 JSON 的模块）输出上述新字段即可；暂无字段时可返回空数组/空对象，前端兼容。
- **前端**：`static/app.js` 当前仅展示 `summary` 与 `curve` 的简单表格和 SVG 折线。新增「决策驾驶舱」页或 Tab 时，请求同一 `result`，按新结构渲染 K 线、区间、双曲线、信号面板、概率区。
- **策略层**：后续可在策略中通过 `context` 或日志结构输出「当前 bar 的买卖原因」，由回测脚本收集写入 `signals[].reasons`。

---

本文档为「决策驾驶舱」的单一设计来源，实现时按路线图分阶段推进即可。

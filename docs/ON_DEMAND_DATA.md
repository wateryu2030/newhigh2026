# 按需拉取数据方案（无需全量导入 A 股）

## 问题

若将全部 A 股历史数据导入本地数据库，会占用大量内存和硬盘，且维护成本高。

## 方案：按需拉取 + 本地缓存

- **不预先导入全市场**：只保存用户实际用到的股票数据。
- **回测前自动检查**：使用「数据库」数据源运行回测时，先检查本地是否有该股票在回测区间的数据。
- **缺数据则自动拉取**：若无数据或数据不足（如不足 10 条），则从 AKShare 拉取该股票在回测起止日期的日线数据，写入本地数据库，再执行回测。
- **结果**：数据库只增长「被回测过的股票」的数据，硬盘占用可控。

## 使用方式

1. 在 Web 平台选择「数据源：数据库」。
2. 选择或输入任意 A 股代码（如 `600519`、`000858`）。
3. 选择回测区间后点击「运行回测」。
4. 若本地无该股票在该区间的数据，会先提示「正在按需拉取…」，拉取并写入后再执行回测。

无需事先执行「同步」或全量导入；需要某只股票时由系统按需拉取并缓存。

## 技术实现

- 在 `web_platform.py` 的 `/api/run_backtest` 中，当 `data_source == "database"` 时：
  1. 解析 `stock_code`，查询本地 DB 该合约在 `start_date`～`end_date` 的日线条数。
  2. 若不存在或条数 &lt; 10，则调用 `DataFetcher.fetch_stock_data(symbol, start_ymd, end_ymd)` 拉取并写入 DB。
  3. 再调用 `run_backtest_db.py` 执行回测。
- 数据仍写入 `data/astock.db`，与现有「数据库数据源」一致，仅改为按需写入。

## 可选：仅同步部分股票

若希望提前缓存少量标的，可继续使用同步脚本，例如：

```bash
python database/sync_data.py --symbol 600519 --days 365
python database/sync_data.py --strategy   # 同步策略用到的股票
```

这样可在无网络时对已同步标的做离线回测；其他股票仍会在首次回测时按需拉取。

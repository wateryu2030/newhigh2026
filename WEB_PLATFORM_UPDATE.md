# Web 平台更新说明

## 更新内容

### ✅ 1. 策略下拉菜单
- 自动扫描 `strategies/` 目录下的所有策略文件
- 排除 `__init__.py` 和 `utils.py`
- 支持点击列表项或下拉菜单选择策略

### ✅ 2. 股票代码选择功能
- **下拉菜单**：从数据库加载已存储的股票列表
- **自定义输入**：支持手动输入股票代码（自动添加交易所后缀）
- **数据同步**：一键同步股票数据到数据库

### ✅ 3. 通用策略模板
- **`strategies/universal_ma_strategy.py`**：支持动态股票代码
- 通过环境变量 `STOCK_CODE` 传递股票代码
- 适用于测试不同股票的回测

### ✅ 4. 数据源选择
- **数据库数据源**（推荐）：离线回测，速度快
- **AKShare 数据源**：实时数据，需要网络

### ✅ 5. 动态策略注入
- 对于不支持动态股票代码的策略，自动创建临时版本
- 自动替换策略中的硬编码股票代码
- 回测完成后自动清理临时文件

## 使用方法

### 1. 启动 Web 平台

```bash
source venv/bin/activate
python web_platform.py
```

访问：http://127.0.0.1:5050

### 2. 选择策略

1. 在"策略列表"中点击策略，或
2. 在"回测配置"的下拉菜单中选择策略

### 3. 选择股票

**方式一：从数据库选择**
1. 在"股票代码"下拉菜单中选择已存储的股票
2. 如果没有数据，点击"同步选中股票数据"按钮

**方式二：手动输入**
1. 在"或输入代码"输入框中输入股票代码（如 `600745`）
2. 系统会自动添加交易所后缀（`600745.XSHG`）

### 4. 配置回测参数

- **开始日期**：回测起始日期
- **结束日期**：回测结束日期
- **初始资金**：回测初始资金（默认 100万）
- **数据源**：选择数据库或 AKShare

### 5. 运行回测

点击"🚀 运行回测"按钮，查看回测日志和结果。

## 策略文件要求

### 通用策略（推荐）

使用 `universal_ma_strategy.py` 作为模板，支持动态股票代码：

```python
def init(context):
    import os
    stock_code = os.environ.get('STOCK_CODE', '600745.XSHG')
    context.stock = stock_code
    # ...
```

### 传统策略

对于硬编码股票代码的策略，系统会自动创建临时版本并替换股票代码。

## API 端点

### GET `/api/strategies`
获取所有策略文件列表

### GET `/api/stocks`
获取数据库中的股票列表

### POST `/api/sync_stock`
同步股票数据到数据库
```json
{
  "symbol": "600745",
  "days": 730
}
```

### POST `/api/run_backtest`
运行回测
```json
{
  "strategy": "universal_ma_strategy.py",
  "stockCode": "600745.XSHG",
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "initialCash": "1000000",
  "dataSource": "database"
}
```

## 测试不同股票

1. **添加股票数据**：
   ```bash
   python database/sync_data.py --symbol 000001 --days 365
   ```

2. **在 Web 界面选择股票**：
   - 从下拉菜单选择，或
   - 手动输入股票代码

3. **运行回测**：
   - 选择策略和股票
   - 配置参数
   - 点击运行

4. **对比结果**：
   - 切换不同股票
   - 使用相同策略
   - 对比回测结果

## 注意事项

1. **数据准备**：首次使用需要同步股票数据
2. **策略兼容性**：推荐使用 `universal_ma_strategy.py`
3. **数据源选择**：数据库数据源需要先同步数据
4. **回测时间**：复杂策略可能需要较长时间

## 故障排除

### 股票列表为空
- 运行 `python database/sync_data.py --symbol <代码>`
- 或使用 Web 界面的"同步选中股票数据"功能

### 策略未显示
- 检查 `strategies/` 目录下是否有 `.py` 文件
- 确保文件不是 `__init__.py` 或 `utils.py`

### 回测失败
- 检查股票代码格式（需要 `.XSHG` 或 `.XSHE` 后缀）
- 确认数据库中有该股票的数据
- 查看回测日志中的错误信息

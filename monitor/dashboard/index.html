<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astock å®ç›˜ç›‘æ§</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #e6edf3; --muted: #8b949e; --green: #3fb950; --red: #f85149; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .header h1 { margin: 0; font-size: 1.25rem; }
    .api-base { font-size: 0.85rem; color: var(--muted); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem 1.5rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
    .card h3 { margin: 0 0 0.5rem; font-size: 0.9rem; color: var(--muted); }
    .card .value { font-size: 1.5rem; font-weight: 600; }
    .card .value.positive { color: var(--green); }
    .card .value.negative { color: var(--red); }
    .chart-wrap { padding: 0 1.5rem 1.5rem; }
    #tv_chart { height: 420px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { text-align: left; padding: 0.5rem; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 500; }
    .empty { color: var(--muted); padding: 1rem; }
    .error { color: var(--red); font-size: 0.9rem; }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ“Š Astock å®ç›˜ç›‘æ§</h1>
    <span class="api-base" id="apiBase">API: --</span>
  </header>
  <div class="grid">
    <div class="card">
      <h3>ç´¯è®¡ç›ˆäº (PnL)</h3>
      <div class="value" id="pnl">--</div>
    </div>
    <div class="card">
      <h3>æŒä»“æ•°é‡</h3>
      <div class="value" id="positionCount">0</div>
    </div>
    <div class="card">
      <h3>è®¢å•æ•°é‡</h3>
      <div class="value" id="orderCount">0</div>
    </div>
  </div>
  <div class="grid">
    <div class="card" style="grid-column: 1 / -1;">
      <h3>æŒä»“</h3>
      <div id="positionsTable"><table><tbody id="positionsBody"></tbody></table><div class="empty" id="positionsEmpty">æš‚æ— æŒä»“</div></div>
    </div>
    <div class="card" style="grid-column: 1 / -1;">
      <h3>æœ€è¿‘è®¢å•</h3>
      <div id="ordersTable"><table><tbody id="ordersBody"></tbody></table><div class="empty" id="ordersEmpty">æš‚æ— è®¢å•</div></div>
    </div>
  </div>
  <div class="chart-wrap">
    <h3 style="margin: 0 0 0.5rem; color: var(--muted); font-size: 0.9rem;">å‡€å€¼/èµ°åŠ¿ (TradingView çº§)</h3>
    <div id="tv_chart"></div>
  </div>
  <script>
    const API_BASE = ''; // ä¸ FastAPI åŒæºæ—¶ç›´æ¥ä½¿ç”¨ /positions, /pnl ç­‰
    const api = (path) => fetch((API_BASE || window.location.origin) + path).then(r => r.json());

    document.getElementById('apiBase').textContent = 'API: ' + (window.location.origin || '');

    function renderPnL(pnl) {
      const el = document.getElementById('pnl');
      const n = Number(pnl);
      el.textContent = (n >= 0 ? '+' : '') + n.toFixed(2);
      el.classList.toggle('positive', n > 0); el.classList.toggle('negative', n < 0);
    }
    function renderPositions(positions) {
      const tbody = document.getElementById('positionsBody');
      const empty = document.getElementById('positionsEmpty');
      tbody.innerHTML = '';
      if (!positions || !positions.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      positions.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (p.code || p.symbol || '-') + '</td><td>' + (p.name || '-') + '</td><td>' + (p.quantity ?? '-') + '</td><td>' + (p.market_value ?? p.value ?? '-') + '</td>';
        tbody.appendChild(tr);
      });
      document.getElementById('positionCount').textContent = positions.length;
    }
    function renderOrders(orders) {
      const tbody = document.getElementById('ordersBody');
      const empty = document.getElementById('ordersEmpty');
      tbody.innerHTML = '';
      if (!orders || !orders.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (o.code || o.symbol || '-') + '</td><td>' + (o.side || o.type || '-') + '</td><td>' + (o.quantity ?? '-') + '</td><td>' + (o.price ?? '-') + '</td><td>' + (o.time || o.created_at || '-') + '</td>';
        tbody.appendChild(tr);
      });
      document.getElementById('orderCount').textContent = orders.length;
    }
    function buildChart() {
      const container = document.getElementById('tv_chart');
      if (!window.lightweightCharts) return;
      const chart = window.lightweightCharts.createChart(container, { layout: { background: { type: 'solid', color: '#161b22' }, textColor: '#8b949e' }, grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } }, width: container.clientWidth, height: 420 });
      const line = chart.addLineSeries({ color: '#3fb950', lineWidth: 2 });
      const now = Math.floor(Date.now() / 1000); const day = 86400;
      line.setData([...Array(30)].map((_, i) => ({ time: now - (30 - i) * day, value: 1 + Math.random() * 0.1 })));
      chart.timeScale().fitContent();
      window._chart = chart;
    }
    function refresh() {
      api('/positions').then(d => { renderPositions(d.positions); }).catch(() => {});
      api('/orders').then(d => { renderOrders(d.orders); }).catch(() => {});
      api('/pnl').then(d => { renderPnL(d.pnl); }).catch(() => {});
    }
    refresh();
    setInterval(refresh, 10000);
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', buildChart);
    else buildChart();
  </script>
</body>
</html>
